<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Testing Environment</title>
    <!-- Cache buster: v20250122-001 -->
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --surface: #ffffff;
            --surface-2: #f1f5f9;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius-lg: 18px;
            --radius-md: 14px;
            --radius-sm: 10px;
            --shadow-sm: 0 1px 2px rgb(15 23 42 / 0.05);
            --shadow: 0 10px 25px rgb(15 23 42 / 0.08);
            --shadow-lg: 0 20px 45px rgb(15 23 42 / 0.12);
        }

        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background:
                radial-gradient(900px 650px at 18% 12%, rgba(79, 70, 229, 0.14), transparent 60%),
                radial-gradient(900px 650px at 85% 78%, rgba(14, 165, 233, 0.10), transparent 60%),
                linear-gradient(180deg, var(--bg) 0%, #ffffff 100%);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        body::after {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: radial-gradient(rgba(15, 23, 42, 0.06) 1px, transparent 1px);
            background-size: 26px 26px;
            opacity: 0.35;
            mask-image: radial-gradient(circle at 50% 15%, black 0%, transparent 70%);
        }

        /* Responsive shell */
        @media (max-width: 900px) {
            .container {
                padding: 2.25rem 1rem;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
            }

            h1 {
                font-size: 2.1rem;
            }

            .tabs {
                width: 100%;
                flex-wrap: wrap;
            }
        }

        .container {
            width: 100%;
            max-width: 1100px;
            padding: 3rem 1.5rem;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* Hero Header */
        header {
            width: 100%;
            margin-bottom: 2.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            position: relative;
        }

        .header-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.05em;
            margin: 0;
            background: linear-gradient(135deg, #0f172a 0%, var(--primary) 75%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--surface);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .user-pill b {
            font-weight: 700;
            color: var(--primary);
        }

        /* Modern Card */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        /* Quick stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.9rem;
            margin-bottom: 1.25rem;
        }

        .stat-card {
            padding: 1.1rem 1.1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.92);
            box-shadow: var(--shadow-sm);
        }

        .stat-label {
            font-size: 0.72rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .stat-value {
            font-size: 1.55rem;
            font-weight: 900;
            letter-spacing: -0.03em;
            margin-top: 0.25rem;
            color: var(--text-main);
        }

        .stat-hint {
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 460px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: rgba(241, 245, 249, 0.8);
            padding: 0.35rem;
            border-radius: var(--radius-md);
            margin-bottom: 2rem;
            width: fit-content;
            border: 1px solid var(--border);
        }

        .tab {
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: #ffffff;
            transition: all 0.2s;
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.12);
        }

        .drop-zone {
            border: 2px dashed #e2e8f0;
            padding: 3rem;
            text-align: center;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface-2);
            color: var(--text-muted);
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: #f1f5f9;
            color: var(--primary);
        }

        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.06);
            color: var(--text-main);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.12);
        }

        /* Buttons */
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:hover {
            background: var(--primary-hover);
            box-shadow: 0 10px 22px rgba(79, 70, 229, 0.20);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: rgba(241, 245, 249, 0.9);
            color: var(--text-main);
        }

        .btn-danger {
            background: #fee2e2;
            color: #b91c1c;
        }

        .btn-danger:hover {
            background: #fecaca;
            box-shadow: none;
        }

        /* App Items */
        .app-item {
            padding: 1.1rem 1.25rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            gap: 1rem;
        }

        .app-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .apps-list {
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .app-details {
            min-width: 0;
        }

        .app-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        @media (max-width: 720px) {
            .app-item {
                flex-direction: column;
                align-items: stretch;
            }

            .app-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .status-running {
            background: #dcfce7;
            color: #166534;
        }

        .status-running::before {
            content: "";
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
        }

        .status-stopped {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-stopped::before {
            content: "";
            width: 6px;
            height: 6px;
            background: #ef4444;
            border-radius: 50%;
        }

        .category-tag {
            font-size: 0.65rem;
            font-weight: 800;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .tag-frontend {
            background: #e0e7ff;
            color: #3730a3;
        }

        .tag-backend {
            background: #fef3c7;
            color: #92400e;
        }

        /* Admin Layout */
        .dev-section {
            margin-bottom: 2rem;
        }

        .dev-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .dev-header::after {
            content: "▾";
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .dev-header.open::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .dev-header:hover {
            border-color: var(--primary);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            box-shadow: var(--shadow-sm);
        }

        .dev-name {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .status-msg {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
        }

        .success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Dashboard layout */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1.25fr 0.75fr;
            gap: 1.5rem;
            align-items: start;
        }

        .dashboard-main {
            min-width: 0;
        }

        .dashboard-side {
            min-width: 0;
        }

        @media (max-width: 900px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
        }

        /* History */
        .history-card {
            padding: 0;
            overflow: hidden;
        }

        .history-card-header {
            padding: 1.1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 1rem;
            background: linear-gradient(180deg, rgba(241, 245, 249, 0.75) 0%, rgba(255, 255, 255, 0) 100%);
            flex-wrap: wrap;
        }

        .history-card-title {
            font-size: 1.05rem;
            font-weight: 800;
            margin: 0;
        }

        .history-card-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
            white-space: nowrap;
        }

        .history-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .history-filters {
            display: inline-flex;
            gap: 0.4rem;
            padding: 0.25rem;
            border: 1px solid var(--border);
            border-radius: 999px;
            background: rgba(241, 245, 249, 0.8);
        }

        .pill {
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
            padding: 0.35rem 0.7rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: none;
        }

        .pill:hover {
            background: rgba(255, 255, 255, 0.85);
            color: var(--text-main);
        }

        .pill.active {
            background: var(--surface);
            color: var(--primary);
            border-color: rgba(79, 70, 229, 0.18);
        }

        .history-search {
            width: min(320px, 75vw);
            padding: 0.55rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 999px;
            font-size: 0.85rem;
            background: rgba(255, 255, 255, 0.95);
            font-family: inherit;
        }

        .history-search:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.12);
        }

        .history-list {
            max-height: 520px;
            overflow: auto;
            scrollbar-gutter: stable;
            scrollbar-color: rgba(100, 116, 139, 0.55) rgba(226, 232, 240, 0.55);
            scrollbar-width: thin;
        }

        .history-list::-webkit-scrollbar {
            width: 10px;
        }

        .history-list::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.55);
            border-left: 1px solid rgba(226, 232, 240, 0.75);
        }

        .history-list::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.55);
            border-radius: 999px;
            border: 3px solid rgba(226, 232, 240, 0.55);
        }

        @media (prefers-reduced-motion: no-preference) {
            .history-item {
                animation: fadeUp 180ms ease-out both;
            }

            @keyframes fadeUp {
                from { opacity: 0; transform: translateY(6px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }

        @media (max-width: 900px) {
            .history-list {
                max-height: 420px;
            }
        }

        .history-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.75rem;
            align-items: start;
            font-size: 0.88rem;
            background: rgba(255, 255, 255, 0.75);
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-main {
            min-width: 0;
        }

        .history-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            min-width: 0;
        }

        .history-action {
            font-weight: 800;
            text-transform: capitalize;
            letter-spacing: -0.01em;
        }

        .history-app {
            font-weight: 700;
            color: var(--text-main);
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            margin-top: 0.35rem;
            font-size: 0.78rem;
            color: var(--text-muted);
            line-height: 1.35;
        }

        .history-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            white-space: nowrap;
            text-align: right;
            padding-top: 0.15rem;
        }

        .history-badge {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 0.22rem 0.55rem;
            font-size: 0.72rem;
            font-weight: 800;
            border: 1px solid var(--border);
            background: rgba(241, 245, 249, 0.9);
            color: var(--text-muted);
        }

        .history-badge.upload {
            background: rgba(79, 70, 229, 0.09);
            color: #3730a3;
            border-color: rgba(79, 70, 229, 0.20);
        }

        .history-badge.delete {
            background: rgba(239, 68, 68, 0.10);
            color: #991b1b;
            border-color: rgba(239, 68, 68, 0.22);
        }

        .history-badge.docker {
            background: rgba(14, 165, 233, 0.10);
            color: #075985;
            border-color: rgba(14, 165, 233, 0.22);
        }

        @media (max-width: 560px) {
            .history-item {
                grid-template-columns: 1fr;
            }

            .history-time {
                text-align: left;
            }
        }

        /* Small layout fixes for inline grids */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 720px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Testing Env</h1>
            <div id="userInfo" class="user-pill"></div>
            <div class="header-meta">Updated: <span id="cacheVersion"></span></div>
        </header>

        <div class="card upload-card">
            <div class="tabs">
                <div class="tab active" data-tab="zip">ZIP Upload</div>
                <div class="tab" data-tab="docker">Docker Image</div>
            </div>

            <div id="zipTab" class="tab-content active">
                <div id="step1">
                    <div class="form-group">
                        <label for="appName">Application Name</label>
                        <input type="text" id="appName" name="appName" placeholder="e.g. dashboard-v2" required
                            pattern="[a-z0-9-]+">
                    </div>
                    <button type="button" id="nextBtn">Continue to Files</button>
                </div>

                <div id="step2" style="display: none;">
                    <div
                        style="margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
                        <span id="displayAppName" style="font-weight: 700; color: var(--primary)"></span>
                        <button type="button" id="backBtn" class="btn-ghost"
                            style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Change Name</button>
                    </div>
                    <form id="uploadForm">
                        <div class="form-group">
                            <div class="drop-zone" id="dropZone">
                                <p>Drag & drop ZIP file here or click to select</p>
                                <input type="file" id="fileInput" name="file" accept=".zip" style="display: none"
                                    required>
                                <p id="fileName" style="margin-top: 0.5rem; font-weight: 600; color: var(--primary)">
                                </p>
                            </div>
                        </div>
                        <button type="submit" id="submitBtn">Deploy to Production</button>
                    </form>
                </div>
            </div>

            <div id="dockerTab" class="tab-content">
                <form id="dockerForm">
                    <div class="form-group">
                        <label for="dockerAppName">Application Name</label>
                        <input type="text" id="dockerAppName" name="appName" placeholder="e.g. redis-app" required
                            pattern="[a-z0-9-]+">
                    </div>

                    <div id="uploadFields">
                        <div class="form-group">
                            <label>Docker Image File (.tar/.tar.gz)</label>
                            <div class="drop-zone" id="dockerDropZone">
                                <p>Drag & drop .tar/.tar.gz file here or click to select</p>
                                <input type="file" id="dockerFileInput" name="file" accept=".tar,.tar.gz,.tgz,application/x-tar,application/gzip" style="display: none"
                                    required>
                                <p id="dockerFileName"
                                    style="margin-top: 0.5rem; font-weight: 600; color: var(--primary)"></p>
                            </div>
                        </div>
                    </div>

                    <div class="two-col">
                        <div class="form-group">
                            <label for="dockerCategory">Category</label>
                            <select id="dockerCategory" name="category">
                                <option value="frontend">Frontend</option>
                                <option value="backend" selected>Backend</option>
                                 <option value="backend" selected>Full Application</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="internalPort">Internal Port</label>
                            <input type="text" id="internalPort" name="internalPort" placeholder="80" value="80">
                        </div>
                    </div>
                    
                    <!-- Debug info -->
                    <div style="margin: 1rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.8rem; color: #666;">
                        <strong>Debug:</strong> Docker input accepts: .tar, .tar.gz, .tgz, application/x-tar, application/gzip
                        <br>
                    </div>
                    
                    <button type="submit" id="dockerSubmitBtn">Deploy Container</button>
                </form>
            </div>

            <div id="status" class="status-msg"></div>
        </div>

        <div id="dashboardSection">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 800;">Deployments</h2>
                <div id="breadcrumbs" style="display: none; font-size: 0.9rem; color: var(--text-muted);"></div>
            </div>

            <div id="statsRow" class="stats-grid" style="display: none;"></div>

            <div class="dashboard-layout">
                <div class="dashboard-main">
                    <div id="viewContainer">
                        <div id="appsList" class="card" style="padding: 0;">
                            <div style="padding: 3rem; text-align: center; color: var(--text-muted)">Initialising...</div>
                        </div>
                    </div>
                </div>

                <aside class="dashboard-side">
                    <div id="historySection" style="display: none;">
                        <div class="card history-card">
                            <div class="history-card-header">
                                <h2 class="history-card-title">Activity Logs</h2>
                                <div class="history-controls">
                                    <div class="history-filters" id="historyFilters" aria-label="History filters">
                                        <button type="button" class="pill active" data-history-filter="all">All</button>
                                        <button type="button" class="pill" data-history-filter="upload">Upload</button>
                                        <button type="button" class="pill" data-history-filter="delete">Delete</button>
                                        <button type="button" class="pill" data-history-filter="docker">Docker</button>
                                    </div>
                                    <input id="historySearch" class="history-search" type="search" placeholder="Search app or user…" autocomplete="off" />
                                    <div class="history-card-subtitle" id="historyMeta">Latest events</div>
                                </div>
                            </div>
                            <div id="historyList" class="history-list">
                                <div style="padding: 2rem; text-align: center; color: var(--text-muted)">No activity yet.</div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        // Force cache clear on page load
        const CURRENT_VERSION = '20250122-001';
        const STORED_VERSION = localStorage.getItem('appVersion');
        
        if (STORED_VERSION !== CURRENT_VERSION) {
            console.log('Version mismatch. Clearing cache and reloading...');
            localStorage.setItem('appVersion', CURRENT_VERSION);
            // Clear all localStorage for this app
            Object.keys(localStorage).forEach(key => {
                if (key !== 'appVersion' && key !== 'user') {
                    localStorage.removeItem(key);
                }
            });
            // Force reload without cache
            window.location.reload(true);
        }
        
        // Cache busting and version indicator
        document.getElementById('cacheVersion').textContent = new Date().toLocaleTimeString();
        
        const form = document.getElementById('uploadForm');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const status = document.getElementById('status');
        const submitBtn = document.getElementById('submitBtn');
        const appsList = document.getElementById('appsList');
        const breadcrumbs = document.getElementById('breadcrumbs');
        const viewContainer = document.getElementById('viewContainer');
        const dockerForm = document.getElementById('dockerForm');
        const dockerSubmitBtn = document.getElementById('dockerSubmitBtn');
        const dockerDropZone = document.getElementById('dockerDropZone');
        const dockerFileInput = document.getElementById('dockerFileInput');
        const dockerFileName = document.getElementById('dockerFileName');

        // Docker File Drag & Drop
        dockerDropZone.addEventListener('dragover', (e) => { e.preventDefault(); dockerDropZone.classList.add('dragover'); });
        dockerDropZone.addEventListener('dragleave', () => { dockerDropZone.classList.remove('dragover'); });
        dockerDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dockerDropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                const file = e.dataTransfer.files[0];
                console.log('Docker file dropped:', file.name, 'Type:', file.type, 'Size:', file.size);
                dockerFileInput.files = e.dataTransfer.files;
                dockerFileName.textContent = 'Selected: ' + file.name;
            }
        });
        dockerDropZone.addEventListener('click', () => dockerFileInput.click());
        dockerFileInput.addEventListener('change', () => {
            if (dockerFileInput.files.length) {
                const file = dockerFileInput.files[0];
                console.log('Docker file selected:', file.name, 'Type:', file.type, 'Size:', file.size);
                dockerFileName.textContent = 'Selected: ' + file.name;
            }
        });

        // Tabs Logic
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                console.log('Tab clicked:', tab.dataset.tab);
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const targetTab = document.getElementById(`${tab.dataset.tab}Tab`);
                targetTab.classList.add('active');
                console.log('Activated tab:', targetTab.id);
                status.style.display = 'none';
            });
        });

        // Auth Check
        const userStr = localStorage.getItem('user');
        if (!userStr) {
            window.location.href = '/login.html';
        }
        const user = JSON.parse(userStr);

        // Hide upload form for Admin
        if (user.role === 'admin') {
            document.querySelector('.upload-card').style.display = 'none';
        }

        document.getElementById('userInfo').innerHTML = `
            <span>Logged in as <b>${user.username}</b></span>
            <button id="logoutBtn" class="btn-ghost" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">Logout</button>`;

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.reload();
        });

        async function fetchWithAuth(url, options = {}) {
            options.headers = {
                ...options.headers,
                'x-user': JSON.stringify(user)
            };
            const res = await fetch(url, options);
            if (res.status === 401) {
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }
            return res;
        }

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                updateFileName();
            }
        });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', updateFileName);

        function updateFileName() {
            if (fileInput.files.length) {
                fileName.textContent = 'Selected: ' + fileInput.files[0].name;
            }
        }

        // Multi-Step Logic
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const nextBtn = document.getElementById('nextBtn');
        const backBtn = document.getElementById('backBtn');
        const appNameInput = document.getElementById('appName');
        const displayAppName = document.getElementById('displayAppName');

        nextBtn.addEventListener('click', () => {
            if (!appNameInput.checkValidity()) {
                appNameInput.reportValidity();
                return;
            }
            displayAppName.textContent = "App: " + appNameInput.value;
            step1.style.display = 'none';
            step2.style.display = 'block';
            status.style.display = 'none';
        });

        backBtn.addEventListener('click', () => {
            step1.style.display = 'block';
            step2.style.display = 'none';
        });

        function resetForm() {
            form.reset();
            appNameInput.value = '';
            fileName.textContent = '';
            step1.style.display = 'block';
            step2.style.display = 'none';
        }

        // Upload
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('=== ZIP FORM SUBMITTED ===');
            const formData = new FormData();
            formData.append('appName', appNameInput.value);
            formData.append('file', fileInput.files[0]);

            console.log('ZIP form data:', { appName: appNameInput.value, file: fileInput.files[0] });

            submitBtn.disabled = true;
            submitBtn.textContent = 'Deploying...';
            status.style.display = 'none';

            try {
                console.log('Submitting to /upload');
                // Use XMLHttpRequest for progress
                const res = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/upload', true);
                    xhr.setRequestHeader('x-user', JSON.stringify(user));

                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) resolve(JSON.parse(xhr.responseText));
                        else reject(new Error(JSON.parse(xhr.responseText).error || 'Upload failed'));
                    };
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.send(formData);
                });

                status.className = 'status-msg success';
                const host = window.location.hostname;
                const link = `http://${host}:${res.port}/`;
                status.innerHTML = `✅ Deployed successfully! <a href="${link}" target="_blank">Open App</a>`;
                status.style.display = 'block';
                resetForm();
                loadApps();
            } catch (err) {
                console.error('ZIP deployment error:', err);
                status.className = 'status-msg error';
                status.textContent = '❌ Error: ' + err.message;
                status.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Deploy Build';
            }
        });

        // Docker Deploy
        dockerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('=== DOCKER FORM SUBMITTED ===');
            const appName = document.getElementById('dockerAppName').value;
            const internalPort = document.getElementById('internalPort').value;
            const category = document.getElementById('dockerCategory').value;

            console.log('Docker form data:', { appName, internalPort, category });
            console.log('Docker file:', dockerFileInput.files[0]);

            dockerSubmitBtn.disabled = true;
            dockerSubmitBtn.textContent = 'Deploying...';
            status.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('appName', appName);
                formData.append('internalPort', internalPort);
                formData.append('category', category);
                formData.append('file', dockerFileInput.files[0]);

                console.log('Submitting to /api/upload-docker-image');
                const res = await fetchWithAuth('/api/upload-docker-image', {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Deployment failed');
                }

                const result = await res.json();
                status.className = 'status-msg success';
                const host = window.location.hostname;
                const link = `http://${host}:${result.port}/`;
                status.innerHTML = `✅ Container deployed successfully! <a href="${link}" target="_blank">Open App</a>`;
                status.style.display = 'block';
                dockerForm.reset();
                dockerFileName.textContent = '';
                loadApps();
            } catch (err) {
                console.error('Docker deployment error:', err);
                status.className = 'status-msg error';
                status.textContent = '❌ Error: ' + err.message;
                status.style.display = 'block';
            } finally {
                dockerSubmitBtn.disabled = false;
                dockerSubmitBtn.textContent = 'Deploy Container';
            }
        });

        // --- DASHBOARD LOGIC ---

        // State
        let allApps = {};
        let allDevelopers = [];
        let allHistory = [];
        let historyFilter = 'all';
        let historyQuery = '';

        const historySearchEl = document.getElementById('historySearch');
        const historyFiltersEl = document.getElementById('historyFilters');
        const statsRowEl = document.getElementById('statsRow');

        function updateStats(apps) {
            if (!statsRowEl) return;

            const entries = Object.entries(apps || {});
            const total = entries.length;
            let zipCount = 0;
            let dockerCount = 0;
            let running = 0;
            let stopped = 0;

            for (const [, info] of entries) {
                const type = (typeof info === 'object' && info.type) ? info.type : 'zip';
                const status = (typeof info === 'object' && info.status) ? info.status : (type === 'zip' ? 'running' : 'unknown');

                if (type === 'docker') dockerCount += 1;
                else zipCount += 1;

                if (status === 'running') running += 1;
                if (status === 'stopped') stopped += 1;
            }

            statsRowEl.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Apps</div>
                    <div class="stat-value">${total}</div>
                    <div class="stat-hint">Across your account</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ZIP Deploys</div>
                    <div class="stat-value">${zipCount}</div>
                    <div class="stat-hint">Static builds</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Docker Apps</div>
                    <div class="stat-value">${dockerCount}</div>
                    <div class="stat-hint">Containers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Running / Stopped</div>
                    <div class="stat-value">${running}<span style="color: var(--text-muted); font-weight: 900;"> / </span>${stopped}</div>
                    <div class="stat-hint">Docker status</div>
                </div>
            `;

            statsRowEl.style.display = 'grid';
        }

        function setActiveHistoryFilter(nextFilter) {
            historyFilter = nextFilter;
            if (!historyFiltersEl) return;
            historyFiltersEl.querySelectorAll('[data-history-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.historyFilter === historyFilter);
            });
        }

        function applyHistoryFilter() {
            const q = (historyQuery || '').trim().toLowerCase();
            const filtered = (allHistory || []).filter(item => {
                const rawAction = (item.action || (item.deletedAt ? 'delete' : 'upload'));
                const matchesType = historyFilter === 'all' ? true : rawAction.includes(historyFilter);
                if (!matchesType) return false;

                if (!q) return true;
                const haystack = `${item.appName || ''} ${item.owner || ''} ${rawAction}`.toLowerCase();
                return haystack.includes(q);
            });

            renderHistory(filtered, { total: (allHistory || []).length });
        }

        if (historyFiltersEl) {
            historyFiltersEl.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-history-filter]');
                if (!btn) return;
                setActiveHistoryFilter(btn.dataset.historyFilter);
                applyHistoryFilter();
            });
        }

        if (historySearchEl) {
            historySearchEl.addEventListener('input', () => {
                historyQuery = historySearchEl.value;
                applyHistoryFilter();
            });
        }

        async function loadApps() {
            try {
                const res = await fetchWithAuth('/api/status');
                const data = await res.json();
                allApps = data.apps || {};
                allDevelopers = data.developers || [];
                allHistory = data.history || [];

                updateStats(allApps);

                if (user.role === 'admin') {
                    renderAdminView(allApps);
                } else {
                    renderAppList(allApps);
                }
                applyHistoryFilter();
                document.getElementById('historySection').style.display = 'block';
            } catch (err) {
                console.error(err);
                viewContainer.innerHTML = `<div style="padding: 2rem; text-align: center; color: #ef4444">
                    <h3>Failed to load apps</h3>
                    <p>${err.message}</p>
                    <pre style="text-align: left; background: #f1f5f9; padding: 1rem; overflow: auto; font-size: 0.8rem;">${err.stack}</pre>
                </div>`;
            }
        }

        function renderAdminView(apps) {
            // Group by owner
            const appsByOwner = {};

            // Start with all developers from API
            let owners = new Set(allDevelopers);

            // Populate groups
            for (const [name, info] of Object.entries(apps)) {
                let owner = (typeof info === 'object' && info.owner) ? info.owner : 'unknown';
                if (!appsByOwner[owner]) appsByOwner[owner] = {};
                appsByOwner[owner][name] = info;
                owners.add(owner);
            }

            const ownerList = Array.from(owners).sort();

            if (ownerList.length === 0) {
                viewContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #64748b">No developers found</div>';
                return;
            }

            // Controls for Admin
            const controlsHtml = `
                <div class="controls" style="margin-bottom: 2rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button class="btn-ghost" onclick="expandAll()" style="font-size: 0.8rem;">Expand All</button>
                    <button class="btn-ghost" onclick="collapseAll()" style="font-size: 0.8rem;">Collapse All</button>
                </div>
            `;

            const accordionHtml = ownerList.map(owner => {
                const devApps = appsByOwner[owner] || {};
                const appCount = Object.keys(devApps).length;

                return `
                    <div class="dev-section" id="section-${owner}">
                        <div class="dev-header" onclick="toggleSection('${owner}')" id="header-${owner}">
                            <div class="dev-name">${owner}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">${appCount} Deployments</div>
                        </div>
                        <div class="dev-content card" id="content-${owner}" style="display: none; padding: 0; border-top: none; border-top-left-radius: 0; border-top-right-radius: 0;">
                            ${renderAppListHtml(devApps)}
                        </div>
                    </div>
                `;
            }).join('');

            viewContainer.innerHTML = controlsHtml + accordionHtml;
        }

        window.expandAll = () => {
            document.querySelectorAll('.dev-content').forEach(c => c.style.display = 'block');
            document.querySelectorAll('.dev-header').forEach(h => h.classList.add('open'));
        };

        window.collapseAll = () => {
            document.querySelectorAll('.dev-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.dev-header').forEach(h => h.classList.remove('open'));
        };

        window.toggleSection = (owner) => {
            const content = document.getElementById(`content-${owner}`);
            const header = document.getElementById(`header-${owner}`);
            const willOpen = content.style.display === 'none';
            content.style.display = willOpen ? 'block' : 'none';
            if (header) header.classList.toggle('open', willOpen);
        };

        function renderAppListHtml(apps) {
            if (Object.keys(apps).length === 0) {
                return '<div style="padding: 3rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">No deployments found.</div>';
            }

            return `
                <div class="apps-list">
                    ${Object.entries(apps).map(([name, info]) => {
                const port = typeof info === 'object' ? info.port : info;
                const owner = typeof info === 'object' ? info.owner : 'unknown';
                const type = info.type || 'zip';
                const status = info.status || (type === 'zip' ? 'running' : 'unknown');
                const category = info.category || 'frontend';

                return `
                                <div class="app-item" id="app-${name}">
                                    <div class="app-details" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <span style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">${name}</span>
                                            <span class="category-tag tag-${category}">${category}</span>
                                            ${type === 'docker' ? `<span class="status-badge status-${status}">${status}</span>` : ''}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 1rem; color: var(--text-muted); font-size: 0.8rem; font-weight: 500;">
                                            <span>Port: <b>${port}</b></span>
                                            <span>Type: <b>${type.toUpperCase()}</b></span>
                                            <span>Owner: <b>${owner}</b></span>
                                        </div>
                                    </div>
                                    <div class="app-actions">
                                        <a href="http://${window.location.hostname}:${port}/" target="_blank" class="app-link" style="text-decoration: none;">
                                            <button class="btn-ghost" style="padding: 0.5rem 1rem; font-size: 0.8rem;">Open</button>
                                        </a>
                                        ${(type === 'docker' && user.role !== 'admin') ? `
                                            <button onclick="controlContainer('${name}', 'start')" class="btn-ghost" style="color: var(--success); border-color: #dcfce7; padding: 0.5rem 1rem; font-size: 0.8rem;" ${status === 'running' ? 'disabled' : ''}>Start</button>
                                            <button onclick="controlContainer('${name}', 'stop')" class="btn-ghost" style="color: var(--warning); border-color: #fef3c7; padding: 0.5rem 1rem; font-size: 0.8rem;" ${status === 'stopped' ? 'disabled' : ''}>Stop</button>
                                        ` : ''}
                                        ${user.role !== 'admin' ?
                        `<button onclick="deleteApp('${name}')" class="btn-danger" style="padding: 0.5rem 1rem; font-size: 0.8rem;">Delete</button>`
                        : ''}
                                    </div>
                                </div>
                            `;
            }).join('')}
                </div>
            `;
        }

        function renderAppList(apps) {
            viewContainer.innerHTML = renderAppListHtml(apps);
        }

        function renderHistory(history, opts = {}) {
            const list = document.getElementById('historyList');
            const meta = document.getElementById('historyMeta');
            if (history.length === 0) {
                const total = typeof opts.total === 'number' ? opts.total : history.length;
                if (meta) meta.textContent = total ? `0/${total} events` : 'No events yet';
                list.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted)">No history recorded</div>';
                return;
            }

            if (meta) {
                const total = typeof opts.total === 'number' ? opts.total : history.length;
                meta.textContent = total !== history.length
                    ? `${history.length}/${total} events`
                    : `${history.length} event${history.length === 1 ? '' : 's'}`;
            }

            list.innerHTML = history.map(item => {
                const rawAction = (item.action || (item.deletedAt ? 'delete' : 'upload'));
                const action = rawAction.replaceAll('_', ' ');
                const owner = item.owner || 'unknown';
                const appName = item.appName || 'Unknown App';
                const timestamp = item.timestamp || item.deletedAt || item.deployedAt;

                const badgeClass = rawAction.includes('docker') ? 'docker' : (rawAction.includes('delete') ? 'delete' : (rawAction.includes('upload') ? 'upload' : ''));
                const badgeLabel = rawAction.includes('docker') ? 'docker' : (rawAction.includes('delete') ? 'delete' : (rawAction.includes('upload') ? 'upload' : rawAction));

                return `
                <div class="history-item">
                    <div class="history-main">
                        <div class="history-title">
                            <span class="history-badge ${badgeClass}">${badgeLabel}</span>
                            <span class="history-action">${action}</span>
                            <span style="color: var(--text-muted);">•</span>
                            <span class="history-app" title="${appName}">${appName}</span>
                        </div>
                        <div class="history-meta">
                            Performed by <b>${owner}</b>${item.port ? ` • Port <b>${item.port}</b>` : ''}${item.image ? ` • Image <b>${item.image}</b>` : ''}${item.category ? ` • Category <b>${item.category}</b>` : ''}
                        </div>
                    </div>
                    <div class="history-time">${timestamp ? new Date(timestamp).toLocaleString() : 'N/A'}</div>
                </div>
            `}).join('');
        }

        window.deleteApp = async function (name) {
            if (!confirm(`Are you sure you want to delete ${name}?`)) return;
            try {
                const res = await fetchWithAuth(`/api/apps/${name}`, { method: 'DELETE' });
                if (res.ok) {
                    loadApps();
                } else {
                    const data = await res.json();
                    alert('Failed to delete: ' + data.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        window.showAdminView = function () {
            breadcrumbs.style.display = 'none';
            renderAdminView(allApps);
        }

        window.controlContainer = async function (name, action) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';

            try {
                const res = await fetchWithAuth(`/api/apps/${name}/${action}`, { method: 'POST' });
                const data = await res.json();
                if (res.ok) {
                    loadApps();
                } else {
                    alert(`Failed to ${action}: ` + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (e) {
                alert('Error: ' + e.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        loadApps();
        setInterval(loadApps, 15000);
    </script>
</body>

</html>