map $http_referer $referrer_app_name {
    default "";
    "~*^https?://[^/]+/([^/]+)/" $1;
}

server {
    listen 0.0.0.0:80;
    server_name yourdomain.com localhost;
    
    # Upload UI (Default fallback)
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Common Asset Paths - Route by Referer
    # Next.js, Vite, common static folders
    # location ~ ^/(_next|assets|static)/ {
    #     proxy_pass http://localhost:$target_port;
    #     proxy_http_version 1.1;
    #     proxy_set_header Host $host;
    #     
    #     # If no referer match (target_port=3000), these might properly 404
    #     # Add CORS to allow fonts across ports if needed
    #     add_header Access-Control-Allow-Origin *;
    # }

    # Upload endpoints
    location /upload {
        proxy_pass http://localhost:3000;
        client_max_body_size 2G;
    }
    
    location /api/ {
        proxy_pass http://localhost:3000;
        client_max_body_size 2G;
    }
    
    # Dynamic App Routes
    include /etc/nginx/gateway-routes/*.conf;
}
