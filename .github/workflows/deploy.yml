name: Deploy to Production
on:
  push:
    branches: [ "main" ]
jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    steps:
      - name: Fix Workspace Permissions
        run: |
          echo "Fixing permissions on workspace..."
          if [ -d "$GITHUB_WORKSPACE" ]; then
            sudo chown -R $USER:$USER $GITHUB_WORKSPACE || true
          fi
        continue-on-error: true
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH and Deploy
        run: |
          mkdir -p ~/.ssh
          eval $(ssh-agent -s)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > .ssh_key
          # Ensure file ends with newline
          [ -n "$(tail -c1 .ssh_key)" ] && echo >> .ssh_key
          chmod 600 .ssh_key
          ssh-add .ssh_key
          rm .ssh_key
          
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
            set -e

            echo "Navigating to project folder..."
            cd ${{ secrets.PROJECT_PATH }}

            echo "Pulling latest changes..."
            git fetch --all
            git reset --hard origin/main

            echo "Installing dependencies..."
            npm install --production

            echo "Creating required directories..."
            mkdir -p uploads builds data

            echo "Restarting application via PM2..."
            if command -v pm2 >/dev/null; then
              pm2 restart build-server || pm2 start server.js --name "build-server"
              pm2 save
            else
              echo "PM2 not found. Installing..."
              sudo npm install -g pm2
              pm2 start server.js --name "build-server"
              pm2 save
            fi

            echo "Deployment Complete!"
          '
