name: Deploy to Production
on:
  push:
    branches: [ "main" ]
jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    env:
      SUDO_PASS: aibit
    steps:
      - name: Fix Workspace Permissions
        run: |
          echo "Fixing permissions on workspace..."
          if [ -d "$GITHUB_WORKSPACE" ]; then
            echo "$SUDO_PASS" | sudo -S chown -R $USER:$USER "$GITHUB_WORKSPACE" || true
          fi
        continue-on-error: true
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Locally
        run: |
          echo "Deploying on self-hosted runner (Local)..."
          
          echo "Installing dependencies..."
          npm install --production

          echo "Creating required directories..."
          mkdir -p uploads builds data

          echo "Restarting application via PM2..."
          if command -v pm2 >/dev/null; then
            echo "$SUDO_PASS" | sudo -S pm2 restart build-hosting-platform || \
              echo "$SUDO_PASS" | sudo -S pm2 start server.js --name "build-hosting-platform" --time
            echo "$SUDO_PASS" | sudo -S pm2 save
          else
            echo "PM2 not found. Installing..."
            echo "$SUDO_PASS" | sudo -S npm install -g pm2
            echo "$SUDO_PASS" | sudo -S pm2 start server.js --name "build-hosting-platform" --time
            echo "$SUDO_PASS" | sudo -S pm2 save
          fi

          echo "Deployment Complete!"
