name: Deploy to Production
on:
  push:
    branches: [ "main" ]
jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    env:
      SUDO_PASS: aibit
    steps:
      - name: Fix Workspace Permissions
        run: |
          echo "Fixing permissions on workspace..."
          if [ -d "$GITHUB_WORKSPACE" ]; then
            echo "$SUDO_PASS" | sudo -S chown -R $USER:$USER "$GITHUB_WORKSPACE" || true
          fi
        continue-on-error: true
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Locally
        run: |
          echo "Deploying on self-hosted runner (Local)..."

          # Use the checked-out workspace as the live app directory
          APP_DIR="$GITHUB_WORKSPACE"
          echo "App directory: $APP_DIR"
          cd "$APP_DIR"

          echo "Installing dependencies in app directory..."
          npm install --production

          echo "Creating required directories..."
          mkdir -p uploads builds data

          echo "Restarting application via PM2 from app directory..."
          if command -v pm2 >/dev/null; then
            # Always replace the process so it points at the current APP_DIR
            echo "$SUDO_PASS" | sudo -S pm2 delete build-hosting-platform || true
            echo "$SUDO_PASS" | sudo -S pm2 start server.js --name "build-hosting-platform" --time
            echo "$SUDO_PASS" | sudo -S pm2 save
          else
            echo "PM2 not found. Installing..."
            echo "$SUDO_PASS" | sudo -S npm install -g pm2
            echo "$SUDO_PASS" | sudo -S pm2 start server.js --name "build-hosting-platform" --time
            echo "$SUDO_PASS" | sudo -S pm2 save
          fi

          echo "Deployment Complete!"
